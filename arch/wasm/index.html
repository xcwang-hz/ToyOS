<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ToyOS on Wasm</title>
  <!-- SPDX-License-Identifier: GPL-2.0-only -->

  <style>
    body { 
      background: #222; 
      color: #fff;
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      font-family: sans-serif;
      margin-top: 20px;
    }
    
    canvas {
      display: block;
      border: 2px solid #ffffff; /* Border for visibility */
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.8);
    }

    .status {
      color: #aaa;
      margin-bottom: 10px;
      font-size: 0.9em;
    }
  </style>  
  <script>
    let nextProcessCtxPtr = 0; // Stores the pointer for the NEXT process   
    const initializedContexts = new Set(); 
    let kernelInstance = null;

    const PS2_SCANCODES = {
      "Escape": 0x01, "Digit1": 0x02, "Digit2": 0x03, "Digit3": 0x04, "Digit4": 0x05, "Digit5": 0x06, "Digit6": 0x07, "Digit7": 0x08, 
      "Digit8": 0x09, "Digit9": 0x0A, "Digit0": 0x0B, "Minus": 0x0C, "Equal": 0x0D, "Backspace": 0x0E, "Tab": 0x0F, "KeyQ": 0x10, 
      "KeyW": 0x11, "KeyE": 0x12, "KeyR": 0x13, "KeyT": 0x14, "KeyY": 0x15, "KeyU": 0x16, "KeyI": 0x17, "KeyO": 0x18, 
      "KeyP": 0x19, "BracketLeft": 0x1A, "BracketRight": 0x1B, "Enter": 0x1C, "ControlLeft": 0x1D, "KeyA": 0x1E, "KeyS": 0x1F, "KeyD": 0x20, 
      "KeyF": 0x21, "KeyG": 0x22, "KeyH": 0x23, "KeyJ": 0x24, "KeyK": 0x25, "KeyL": 0x26, "Semicolon": 0x27, "Quote": 0x28, 
      "Backquote": 0x29, "ShiftLeft": 0x2A, "Backslash": 0x2B, "KeyZ": 0x2C, "KeyX": 0x2D, "KeyC": 0x2E, "KeyV": 0x2F, "KeyB": 0x30,
      "KeyN": 0x31, "KeyM": 0x32, "Comma": 0x33, "Period": 0x34, "Slash": 0x35, "ShiftRight": 0x36, "NumpadMultiply": 0x37, "AltLeft": 0x38,
      "Space": 0x39
    };
    document.addEventListener("DOMContentLoaded", async () => {
      const log = (text) => console.log(text);

      // This is needed for SharedArrayBuffer on modern browsers.
      if (!window.crossOriginIsolated) {
        log("Error: Server did not set correct cross-origin-isolated headers.");
      }

      const canvas = document.getElementById('screen');
      const ctx = canvas.getContext('2d');
      let sharedImgData = null;

      let debugLineBuffer = "";
      // initial: 256 pages = 16MB
      // maximum: 256 pages = 16MB
      const wasmMemory = new WebAssembly.Memory({ initial: 256, maximum: 256 });

      const handleKeyEvent = (e, isDown) => {
        // console.log(`Key: ${e.code}, isDown: ${isDown}`);
        if (!kernelInstance) return;

        // Lookup the scancode map
        const scancode = PS2_SCANCODES[e.code];
        if (scancode) {
          if (e.ctrlKey || e.altKey)
             e.preventDefault(); 

          let codeToSend = scancode;
          if (!isDown)
            codeToSend |= 0x80;

          // Call the exported C++ function
          const pendingKeyAddr = kernelInstance.exports.js_pending_key.value; 
          const mem32 = new Int32Array(wasmMemory.buffer);
          mem32[pendingKeyAddr / 4] = codeToSend;
        } else {
          console.warn(`ToyOS_JS: Unmapped key: ${e.code}`);
        }
      };      

      window.addEventListener('keydown', (e) => handleKeyEvent(e, true));
      window.addEventListener('keyup', (e) => handleKeyEvent(e, false));      

      try {
        const importObject = {
          env: {
            memory: wasmMemory,

            // [Graphics Interface]
            canvas_init: (ptr, width, height) => {
              const bufferSize = width * height * 4;
              const dataArray = new Uint8ClampedArray(wasmMemory.buffer, ptr, bufferSize);
              sharedImgData = new ImageData(dataArray, width, height);
            },

            js_debug_char: (ch) => {
              if (ch === 10) { // '\n' is 10
                console.log(`%c[ToyOS] ${debugLineBuffer}`, "color: #00AAFF");
                debugLineBuffer = "";
              } 
              else if (ch !== 13) {
                debugLineBuffer += String.fromCharCode(ch);
              }                
            },
            wasm_async_yield: function(prevCtxPtr, nextCtxPtr) {
              // 1. C++ requested a yield (Unwind Phase)
              if (kernelInstance.exports.asyncify_get_state() == 0) {
                console.log(`[JS] Context Switch: Save to ${prevCtxPtr}, Next is ${nextCtxPtr}`);
                kernelInstance.exports.asyncify_start_unwind(prevCtxPtr);
                initializedContexts.add(prevCtxPtr);
                nextProcessCtxPtr = nextCtxPtr;
              }
              else {
                console.log(`[JS] Process Resumed.`);
                kernelInstance.exports.asyncify_stop_rewind();
              }
            }
          }
        };

        WebAssembly.instantiateStreaming(fetch("toyos.wasm"), importObject)
          .then(async obj => {
            console.log("Wasm Instantiated. Starting Kernel...");
            kernelInstance = obj.instance;
            try {
              kernelInstance.exports.kernel_entry(0, 0);
              ctx.putImageData(sharedImgData, 0, 0);
            } catch (e) {
              console.error("Kernel Error (Init):", e);
              return;
            }

            while (true) {
              if (nextProcessCtxPtr === 0)
                break;

              // Give the browser main thread a chance to render UI/handle inputs
              await new Promise(r => setTimeout(r, 0));
              
              if (initializedContexts.has(nextProcessCtxPtr)) {
                console.log(`[JS] Rewinding existing process: ${nextProcessCtxPtr}`);
                kernelInstance.exports.asyncify_start_rewind(nextProcessCtxPtr);
              }
              else {
                console.log(`[JS] Starting NEW process: ${nextProcessCtxPtr}`);
                if (kernelInstance.exports.asyncify_get_state() !== 0) {
                  if (kernelInstance.exports.asyncify_stop_unwind)
                    kernelInstance.exports.asyncify_stop_unwind();
                  else
                    kernelInstance.exports.asyncify_stop_rewind();
                }                  
              }
              
              try {
                kernelInstance.exports.kernel_entry(0, 0);
                ctx.putImageData(sharedImgData, 0, 0);
              } catch (e) {
                console.error("Kernel Error (Loop):", e);
                break;
              }
            }
          });        
      } catch (error) {
        log("kernel failed with (" + error.name + "): " + error.message + "\n" + error.stack);
        throw error;
      }      
    }, false);
  </script>
</head>

<body>
  <div class="status" id="status">Loading ToyOS...</div>
  <canvas id="screen" width="1024" height="768"></canvas>
</body>
</html>