<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ToyOS on Wasm</title>
  <!-- SPDX-License-Identifier: GPL-2.0-only -->

  <style>
    body { 
      background: #222; 
      color: #fff;
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      font-family: sans-serif;
      margin-top: 20px;
    }
    
    canvas {
      display: block;
    }

    .status {
      color: #aaa;
      margin-bottom: 10px;
      font-size: 0.9em;
    }
  </style>  
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const log = (text) => console.log(text);

      // This is needed for SharedArrayBuffer on modern browsers.
      if (!window.crossOriginIsolated) {
        log("Error: Server did not set correct cross-origin-isolated headers.");
      }

      const canvas = document.getElementById('screen');
      const ctx = canvas.getContext('2d');

      let debugLineBuffer = "";
      // initial: 256 pages = 16MB
      // maximum: 256 pages = 16MB
      const wasmMemory = new WebAssembly.Memory({ initial: 256, maximum: 256 });

      try {
        const importObject = {
          env: {
            memory: wasmMemory,

            // [Graphics Interface]
            canvas_refresh: (ptr, width, height) => {
              // Auto-detection: If this function is called, we are in Graphics Mode.
              // Make the canvas container visible if it isn't already.
              console.log('Graphics signal received. Displaying monitor');
              console.log("JS received ptr:", ptr, "(Hex: 0x" + ptr.toString(16) + ")");

              // Calculate buffer size: Width * Height * 4 bytes (RGBA)
              const bufferSize = width * height * 4;

              // Create a view into the Wasm memory (Shared Memory)
              // Uint8ClampedArray is required for ImageData
              const dataArray = new Uint8ClampedArray(wasmMemory.buffer, ptr, bufferSize);

              // Create ImageData and draw it to the canvas
              const imgData = new ImageData(dataArray, width, height);
              ctx.putImageData(imgData, 0, 0);
            },

            js_debug_char: (ch) => {
              if (ch === 10) { // '\n' is 10
                console.log(`%c[ToyOS] ${debugLineBuffer}`, "color: #00AAFF");
                debugLineBuffer = "";
              } 
              else if (ch !== 13) {
                debugLineBuffer += String.fromCharCode(ch);
              }                
            }
          }
        };

        WebAssembly.instantiateStreaming(fetch("toyos.wasm"), importObject)
          .then(obj => {
              const kernel = obj.instance;
              kernel.exports.kernel_entry(0, 0); 
          });        
      } catch (error) {
        log("kernel failed with (" + error.name + "): " + error.message + "\n" + error.stack);
        throw error;
      }      
    }, false);
  </script>
</head>

<body>
  <div class="status" id="status">Loading ToyOS...</div>
  <canvas id="screen" width="800" height="600"></canvas>
</body>
</html>