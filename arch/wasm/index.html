<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ToyOS on Wasm</title>
  <!-- SPDX-License-Identifier: GPL-2.0-only -->

  <style>
    body { 
      background: #222; 
      color: #fff;
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      font-family: sans-serif;
      margin-top: 20px;
    }
    
    canvas {
      display: block;
    }

    .status {
      color: #aaa;
      margin-bottom: 10px;
      font-size: 0.9em;
    }
  </style>  
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const log = (text) => console.log(text);

      // This is needed for SharedArrayBuffer on modern browsers.
      if (!window.crossOriginIsolated) {
        log("Error: Server did not set correct cross-origin-isolated headers.");
      }

      const canvas = document.getElementById('screen');
      const ctx = canvas.getContext('2d');

      let wasmMemory;
      function readStringFromMemory(offset) {
        if (!wasmMemory) return "";
        const buffer = new Uint8Array(wasmMemory.buffer);
        
        let i = offset;
        while (buffer[i] !== 0) 
          i++;
        const bytes = buffer.subarray(offset, i);
        return new TextDecoder("utf-8").decode(bytes);
      }

      try {
        const importObject = {
          env: {
            // [Graphics Interface]
            canvas_refresh: (ptr, width, height) => {
              // Auto-detection: If this function is called, we are in Graphics Mode.
              // Make the canvas container visible if it isn't already.
              log('Graphics signal received. Displaying monitor');

              // Calculate buffer size: Width * Height * 4 bytes (RGBA)
              const bufferSize = width * height * 4;

              // Create a view into the Wasm memory (Shared Memory)
              // Uint8ClampedArray is required for ImageData
              const dataArray = new Uint8ClampedArray(wasmMemory.buffer, ptr, bufferSize);

              // Create ImageData and draw it to the canvas
              const imgData = new ImageData(dataArray, width, height);
              ctx.putImageData(imgData, 0, 0);
            }
          }
        };

        WebAssembly.instantiateStreaming(fetch("toyos.wasm"), importObject)
          .then(obj => {
              const kernel = obj.instance;
              wasmMemory = kernel.exports.memory;
              kernel.exports.kernel_entry(0, 0); 
          });        
      } catch (error) {
        log("kernel failed with (" + error.name + "): " + error.message + "\n" + error.stack);
        throw error;
      }      
    }, false);
  </script>
</head>

<body>
  <div class="status" id="status">Loading ToyOS...</div>
  <canvas id="screen" width="800" height="600"></canvas>
</body>
</html>